<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bitstream (XC9500) - Project Combine</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Project Combine</h1>

                    <div class="right-buttons">

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bitstream-structure--xc9500"><a class="header" href="#bitstream-structure--xc9500">Bitstream structure — XC9500</a></h1>
<p>On a high level, the whole bitstream is split into "areas".  Each FB
of the device corresponds two areas, one of which contains the UIM wire-AND
configuration, and the other (main area) contains everything else.</p>
<p>The main area of a FB is made of 72 "rows".  Each row is made of 15 "columns".
Each column is made of 6 or 8 bits: columns 0-8 are made of 8 bits, while
columns 9-14 are made of 6 bits.</p>
<p>The low 6 bits of every column are used to store product term masks, and
the high 2 bits of columns 0-8 are used to store everything else.</p>
<p>The UIM wire-AND area of a FB is, in turn, made of "subareas", one for each
FB of the device.  Each subarea is in turn made of 18 rows.  Each row
is made of 5 columns.  Column 0 is made of 8 bits, while columns 1-4 are made
of 7 bits, making for 36 total bits per row.</p>
<p>When programmed or read via JTAG, the bitstream is transmitted as bytes,
which are 6-8 bits long.  Each byte of the bitstream has its address.
Not all addresses are valid, and valid addresses are not contiguous.
Address is 17 bits long, and is split to several fields:</p>
<ul>
<li>
<p>bits 13-16: FB index</p>
</li>
<li>
<p>bit 12: area kind</p>
<ul>
<li>0: main FB config</li>
<li>1: UIM wire-AND config</li>
</ul>
</li>
<li>
<p>for main FB config area:</p>
<ul>
<li>bits 5-11: row</li>
<li>bits 3-4: column / 5</li>
<li>bits 0-2: column % 5</li>
</ul>
</li>
<li>
<p>for UIM wire-AND config area:</p>
<ul>
<li>bits 8-11: subarea (source FB index)</li>
<li>bits 3-7: row</li>
<li>bits 0-2: column</li>
</ul>
</li>
</ul>
<p>The unprogrammed state of a bit on XC9500 is <code>1</code>.
The programmed state is <code>0</code>.  Thus, whenever a boolean fuse is mentioned
in the documentation, the "true" value is actually represented as <code>0</code>
in the bitstream.  This includes the USERCODE bits.</p>
<h2 id="jed-format-mapping"><a class="header" href="#jed-format-mapping">JED format mapping</a></h2>
<p>In the JED format, all fuses of the device are simply concatenated in order,
skipping over invalid addresses.  The bytes are <em>not</em> padded to 8 bits, but
have their native size.  Thus, converting from JED fuse index to device
address involves some complex calculations::</p>
<pre><code class="language-python">main_row_bits = 8 * 9 + 6 * 6
uim_row_bits = 8 + 7 * 4
main_area_bits = main_row_bits * 72
uim_subarea_bits = uim_row_bits * 18
uim_area_bits = uim_subarea_bits * device.num_fbs
fb_bits = main_area_bits + uim_area_bits
total_bits = fb_bits * device.num_fbs

def jed_to_jtag(fuse):
    fb = fuse // fb_bits
    fuse %= fb_bits
    if fuse &lt; main_area_bits:
        row = fuse // main_row_bits
        fuse %= main_row_bits
        if fuse &lt; 8 * 9:
            column = fuse // 8
            bit = fuse % 8
        else:
            fuse -= 8 * 9
            column = 9 + fuse // 6
            bit = fuse % 6
        return (
            fb &lt;&lt; 13 |
            0 &lt;&lt; 12 |
            row &lt;&lt; 5 | 
            (column // 5) &lt;&lt; 3 |
            (column % 5)
        ), bit
    else:
        fuse -= main_area_bits
        subarea = fuse // uim_subarea_bits
        fuse %= uim_subarea_bits
        row = fuse // uim_row_bits
        fuse %= uim_row_bits
        if fuse &lt; 8:
            column = 0
            bit = fuse
        else:
            fuse -= 8
            column = 1 + fuse // 7
            bit = fuse % 7
        return (
            fb &lt;&lt; 13 |
            1 &lt;&lt; 12 |
            subarea &lt;&lt; 8 |
            row &lt;&lt; 3 |
            column
        ), bit

def jtag_to_jed(addr, bit):
    fb = addr &gt;&gt; 13 &amp; 0xf
    assert fb &lt; device.num_fbs
    if addr &amp; (1 &lt;&lt; 12):
        row = addr &gt;&gt; 5 &amp; 0x7f
        assert row &lt; 72
        col_hi = addr &gt;&gt; 3 &amp; 3
        assert col_hi &lt; 3
        col_lo = addr &amp; 7
        assert col_lo &lt; 5
        column = col_hi * 5 + col_lo
        if column &lt; 9:
            cfuse = column * 8 + bit
        else:
            cfuse = 8 * 8 + (column - 9) * 6 + bit
        return fb * fb_bits + row * main_row_bits + cfuse
    else:
        subarea = addr &gt;&gt; 8 &amp; 0xf
        assert subarea &lt; device.num_fbs
        row = addr &gt;&gt; 3 &amp; 0x1f
        assert row &lt; 18
        column = addr &amp; 7
        assert column &lt; 5
        if column == 0:
            cfuse = bit
        else:
            cfuse = 8 + (column - 1) * 7 + bit
        return fb * fb_bits + main_area_bits + subarea * uim_subarea_bits + row * uim_row_bits + cfuse
</code></pre>
<h2 id="fuses--product-terms"><a class="header" href="#fuses--product-terms">Fuses — product terms</a></h2>
<p>The product term masks are stored in bits 0-5 of every column and every row of the main area.
The formulas are as follows:</p>
<ol>
<li><code>FB[i].MC[j].PT[k].IM[l].P</code> is stored at:
<ul>
<li>row: <code>l * 2 + 1</code></li>
<li>column: <code>k + (j % 3) * 5</code></li>
<li>bit: <code>j // 3</code></li>
</ul>
</li>
<li><code>FB[i].MC[j].PT[k].IM[l].N</code> is stored at:
<ul>
<li>row: <code>l * 2</code></li>
<li>column: <code>k + (j % 3) * 5</code></li>
<li>bit: <code>j // 3</code></li>
</ul>
</li>
</ol>
<h2 id="fuses--macrocells"><a class="header" href="#fuses--macrocells">Fuses — macrocells</a></h2>
<p>Per-MC config fuses (that are not product term masks) are stored in bits 6-7 of
columns 0-8 of rows 12-54 of the main area.  The formulas are as follows:</p>
<ul>
<li>row: corresponds to fuse function</li>
<li>column: <code>mc_idx % 9</code></li>
<li>bit: <code>6 + mc_idx // 9</code></li>
</ul>
<p>{{tile xc9500 mc}}</p>
<h2 id="fuses--fb-inputs"><a class="header" href="#fuses--fb-inputs">Fuses — FB inputs</a></h2>
<p>The FB input mux configuraton is stored in rows 55-66, columns 0-8, bits 6-7.
The exact bit assignments are irregular and should be obtained from the database.</p>
<h2 id="fuses--per-fb-bits-and-globals"><a class="header" href="#fuses--per-fb-bits-and-globals">Fuses — per-FB bits and globals</a></h2>
<p>Per-FB bits are stored in rows 67-68, columns 0-8, bits 6-7.  The bits are (row, bit, column):</p>
<p>{{tile xc9500 fb}}</p>
<p>Global bits are stored in rows (0, 3, 4, 6, 7), columns 0-8, bits 6-7 of FB 0.  The bits are (fb, row, bit, column):</p>
<p>{{tile xc9500 global}}</p>
<h2 id="fuses--input-buffer-enable"><a class="header" href="#fuses--input-buffer-enable">Fuses — input buffer enable</a></h2>
<p>On XC95288, the <code>IBUF_UIM_ENABLE</code> fuses are stored in rows (1, 2, 5, 8, 9),
columns 0-8, bits 6-7 of FBs (0, 1, 14, 15) in an irregular manner.  Each
fuse is duplicated twice: once in FBs (0, 1) and once in FBs (14, 15).
The purpose of this duplication is unknown.  Consult the database for exact
bit assignments.</p>
<h2 id="fuses--uim-wire-and"><a class="header" href="#fuses--uim-wire-and">Fuses — UIM wire-AND</a></h2>
<p>The <code>FB[i].IM[j].UIM.FB[k].MC[l]</code> fuse is stored at:</p>
<ul>
<li>subarea: <code>k</code></li>
<li>row: <code>l</code></li>
<li>column: <code>j % 5</code></li>
<li>bit: <code>j // 5</code></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../xc9500/structure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../xc9500/bitstream-xc9500xl.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../xc9500/structure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../xc9500/bitstream-xc9500xl.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
